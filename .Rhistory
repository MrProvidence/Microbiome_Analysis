res_df$Genus <- tax_table(ps_genus)[rownames(res_df), "Genus"]
# remove NA
res_df <- res_df[!is.na(res_df$Genus), ]
# keep only genera with padj < 0.05
res_sig <- res_df %>% filter(padj < 0.05)
# -------------------------
# Plot log2 fold change
# -------------------------
ggplot(res_sig, aes(x = log2FoldChange, y = Genus)) +
geom_point(size = 4) +
geom_vline(xintercept = 0, linetype="dashed") +
theme_bw(base_size = 14) +
labs(x = "log2 Fold Change (TO22 vs deltaAv2)", y = "")
# -------------------------
# Plot log2 fold change
# -------------------------
ggplot(res_sig, aes(x = log2FoldChange, y = Genus)) +
geom_point(size = 4) +
geom_vline(xintercept = 0, linetype="dashed") +
theme_bw(base_size = 14) +
labs(x = "log2 Fold Change (TO22 vs deltaAv2)", y = "")
### 1. Extract taxonomy as dataframe
tax <- as.data.frame(as(tax_table(ps), "matrix"))
tax$ASV <- rownames(tax)
### 2. Convert DESeq2 result to dataframe
res <- as.data.frame(res_TO22_shrunk)
res$ASV <- rownames(res)
### 3. Merge taxonomy + DESeq2
res_tax <- merge(res, tax, by = "ASV")
### 4. Keep only genera and remove NAs
res_tax$Genus <- as.character(res_tax$Genus)
### 5. Filter significant genera (padj < 0.05)
res_sig <- res_tax %>%
filter(!is.na(Genus)) %>%
filter(padj < 0.05)
### 6. Order y-axis by log2FC
res_sig$Genus <- factor(res_sig$Genus,
levels = res_sig$Genus[order(res_sig$log2FoldChange)])
### 7. Plot
ggplot(res_sig, aes(x = log2FoldChange, y = Genus)) +
geom_point(size = 4) +
geom_vline(xintercept = 0, linetype="dashed") +
theme_bw(base_size = 14) +
labs(
x = "log2 Fold Change (TO22 vs deltaAv2)",
y = "Genus"
)
# Single block: clean forest-like log2FC plots at Genus and Phylum
library(tidyverse)
library(phyloseq)
library(ggrepel)
# 1) Prepare dataframes -----------------------------------------------------
# tax table (as plain data.frame)
tax_df <- as.data.frame(as(tax_table(ps), "matrix")) %>%
rownames_to_column(var = "ASV")
# DESeq2 results (shrunken)
res_df <- as.data.frame(res_TO22_shrunk) %>%
rownames_to_column(var = "ASV") %>%
# keep only relevant columns
select(ASV, log2FoldChange, lfcSE = lfcSE, padj)
# join taxonomy + DE results
dat <- left_join(res_df, tax_df, by = "ASV")
# 2) Aggregate to Genus and Phylum -----------------------------------------
agg_summary <- function(df, taxcol, topN = 15, sig_cut = 0.05) {
# df: joined ASV-level df
# taxcol: string, e.g. "Genus" or "Phylum"
tmp <- df %>%
filter(!is.na(.data[[taxcol]])) %>%
group_by(taxon = .data[[taxcol]]) %>%
summarise(
meanLFC = mean(log2FoldChange, na.rm = TRUE),
se    = sqrt(mean(lfcSE^2, na.rm = TRUE)),  # rough combined SE
minPadj = min(padj, na.rm = TRUE),
nASV = n(),
.groups = "drop"
) %>%
mutate(signif = ifelse(is.na(minPadj), FALSE, minPadj < sig_cut))
# choose which taxa to keep:
# prefer significant ones; if too many/too few, take top by absolute effect size
keep <- tmp %>% filter(signif) %>% arrange(desc(abs(meanLFC)))
if (nrow(keep) < 1) {
# no significant taxa -> take topN by absolute LFC
keep <- tmp %>% arrange(desc(abs(meanLFC))) %>% slice(1:topN)
} else if (nrow(keep) > topN) {
keep <- keep %>% slice(1:topN)
} else {
# if fewer than topN significant, add top by abs LFC until topN
add <- tmp %>% filter(!taxon %in% keep$taxon) %>%
arrange(desc(abs(meanLFC))) %>% slice(1:max(0, topN - nrow(keep)))
keep <- bind_rows(keep, add)
}
# order factor for plotting (largest positive on top)
keep <- keep %>% arrange(meanLFC) %>%
mutate(taxon = factor(taxon, levels = unique(taxon)))
keep
}
genus_plot_df  <- agg_summary(dat, "Genus", topN = 20, sig_cut = 0.05) %>% mutate(Level = "Genus")
phylum_plot_df <- agg_summary(dat, "Phylum", topN = 12, sig_cut = 0.05) %>% mutate(Level = "Phylum")
plot_df <- bind_rows(genus_plot_df, phylum_plot_df) %>%
# ensure taxon factor does not clash between panels
group_by(Level) %>%
mutate(taxon = fct_reorder(taxon, meanLFC)) %>%
ungroup()
# 3) Plot: horizontal forest-style two-panel figure -------------------------
p <- ggplot(plot_df, aes(x = meanLFC, y = taxon)) +
geom_point(aes(color = signif), size = 3) +
geom_errorbarh(aes(xmin = meanLFC - 1.96 * se, xmax = meanLFC + 1.96 * se),
height = 0.2, alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "grey40") +
facet_wrap(~Level, scales = "free_y", ncol = 1) +        # vertical stacking (Genus above Phylum)
scale_color_manual(values = c("grey60", "red")) +
labs(x = "log2 Fold Change (TO22 vs deltaAv2)", y = "",
title = "Differential abundance (aggregated taxa)") +
theme_bw(base_size = 12) +
theme(
legend.position = "none",
strip.background = element_rect(fill = "white"),
panel.grid.major.y = element_blank()
)
# Optional: label significant taxa
p <- p + geom_text_repel(data = filter(plot_df, signif),
aes(label = as.character(taxon)),
nudge_x = 0.05, size = 3, segment.size = 0.2)
print(p)
library(tidyverse)
library(phyloseq)
### 1. Extract taxonomy
tax <- as.data.frame(as(tax_table(ps), "matrix"))
tax$ASV <- rownames(tax)
### 2. DESeq2 results → dataframe
res <- as.data.frame(res_TO22_shrunk)
res$ASV <- rownames(res)
### 3. Merge taxonomy + results
res_tax <- merge(res, tax, by = "ASV")
### 4. Keep SIGNIFICANT taxa only (padj < 0.05)
res_sig <- res_tax %>%
filter(!is.na(log2FoldChange),
!is.na(Genus),
padj < 0.05)
### 5. GENUS-LEVEL LFC PLOT
genus_plot <- res_sig %>%
group_by(Genus, Phylum) %>%
summarize(log2FC = mean(log2FoldChange), .groups = "drop") %>%
arrange(log2FC) %>%
mutate(Genus = factor(Genus, levels = Genus))
p_genus <- ggplot(genus_plot, aes(x = log2FC, y = Genus, color = Phylum)) +
geom_point(size = 5) +
geom_vline(xintercept = 0, linetype = "dashed") +
theme_bw(base_size = 14) +
labs(title = "Genus-level log2 Fold Change (TO22 vs deltaAv2)",
x = "log2 Fold Change", y = "") +
theme(
axis.text.y = element_text(face = "italic"),
plot.title = element_text(size = 16, face = "bold")
)
### 6. ORDER-LEVEL LFC PLOT
order_plot <- res_sig %>%
group_by(Order, Phylum) %>%
summarize(log2FC = mean(log2FoldChange), .groups = "drop") %>%
arrange(log2FC) %>%
mutate(Order = factor(Order, levels = Order))
p_order <- ggplot(order_plot, aes(x = log2FC, y = Order, color = Phylum)) +
geom_point(size = 5) +
geom_vline(xintercept = 0, linetype = "dashed") +
theme_bw(base_size = 14) +
labs(title = "Order-level log2 Fold Change (TO22 vs deltaAv2)",
x = "log2 Fold Change", y = "") +
theme(
axis.text.y = element_text(face = "italic"),
plot.title = element_text(size = 16, face = "bold")
)
### 7. Print both
p_genus
p_order
###########DESEQ2
library(DESeq2)
library(ashr)
library(DESeq2)
# Ensure the reference level is deltaAv2
ps@sam_data$Treatment <- relevel(ps@sam_data$Treatment, ref = "deltaAv2")
# Run DESeq2
dds <- DESeq(dds)
# Ensure the reference level is deltaAv2
ps@sam_data$Treatment <- relevel(ps@sam_data$Treatment, ref = "deltaAv2")
# Ensure the reference level is deltaAv2
ps@sam_data$Treatment <- relevel(ps@sam_data$Treatment, ref = "deltaAv2")
# Ensure the reference level is deltaAv2
ps@sam_data$Treatment <- relevel(ps@sam_data$Treatment, ref = "deltaAv2")
str(sample_data(ps)$Treatment)
# Ensure the reference level is deltaAv2
ps@sam_data$Treatment <- factor(ps@sam_data$Treatment)
levels(ps@sam_data$Treatment)
ps@sam_data$Treatment <- relevel(ps@sam_data$Treatment, ref = "deltaAv2")
# Convert phyloseq → DESeq2
dds <- phyloseq_to_deseq2(ps, ~ Treatment)
# Run DESeq2
dds <- DESeq(dds)
res_TO22 <- results(dds, contrast = c("Treatment", "TO22", "deltaAv2"))
res_TO22_shrunk <- lfcShrink(dds,
contrast = c("Treatment","TO22","deltaAv2"),
type = "apeglm")
resultsNames(dds)
resultsNames(dds)
resultsNames(dds)
res_TO22_shrunk <- lfcShrink(dds,
coef = "Treatment_TO22_vs_deltaAv2",
type = "apeglm")
sig <- res[which(res$padj < 0.05),]
tax <- as.data.frame(as(tax_table(ps), "matrix"))
tax$ASV <- rownames(tax)
res_tax <- merge(res_df, tax, by = "ASV")
library(dplyr)
library(ggplot2)
genus_plot_df <- res_tax %>%
filter(!is.na(Genus)) %>%
group_by(Genus) %>%
summarize(
log2FC = mean(log2FoldChange, na.rm = TRUE),
padj = min(padj, na.rm = TRUE)
) %>%
filter(!is.nan(log2FC)) %>%
arrange(log2FC)
genus_plot_df$Genus <- factor(genus_plot_df$Genus, levels = genus_plot_df$Genus)
ggplot(genus_plot_df, aes(x = log2FC, y = Genus)) +
geom_point(size = 3) +
geom_vline(xintercept = 0, linetype = "dashed") +
coord_cartesian(xlim = c(-2, 2)) +
theme_bw(base_size = 12) +
labs(
title = "Differential Abundance (Genus) — TO22 vs deltaAv2",
x = "log2 Fold Change",
y = ""
)
### 1. Make Treatment a factor
sample_data(ps)$Treatment <- factor(sample_data(ps)$Treatment)
### 2. Set reference level
sample_data(ps)$Treatment <- relevel(sample_data(ps)$Treatment, ref = "deltaAv2")
### 3. Build DESeq2 object
dds <- phyloseq_to_deseq2(ps, ~ Treatment)
### 4. Run DESeq
dds <- DESeq(dds)
### 5. Extract TO22 vs deltaAv2 results
res_TO22 <- results(dds, contrast = c("Treatment","TO22","deltaAv2"))
### 6. Shrink LFC **using the correct coefficient name**
coefname <- grep("TO22", resultsNames(dds), value = TRUE)
coefname
res_TO22_shrunk <- lfcShrink(dds, coef = coefname, type = "apeglm")
### Convert to dataframe
res_df <- as.data.frame(res_TO22_shrunk)
library(DESeq2)
# 1️⃣ Make sure Treatment is a factor
sample_data(ps)$Treatment <- factor(sample_data(ps)$Treatment)
# 2️⃣ Set reference level (deltaAv2 MUST exist)
sample_data(ps)$Treatment <- relevel(sample_data(ps)$Treatment, ref = "deltaAv2")
# 3️⃣ Convert phyloseq → DESeq2
dds <- phyloseq_to_deseq2(ps, ~ Treatment)
# 4️⃣ Run DESeq2
dds <- DESeq(dds)
# 5️⃣ Extract TO22 vs deltaAv2
res <- results(dds, contrast = c("Treatment","TO22","deltaAv2"))
# 6️⃣ Shrink LFC
res_shrunk <- lfcShrink(dds,
coef = "Treatment_TO22_vs_deltaAv2",
type = "apeglm")
# 7️⃣ Make clean DF
res_df <- as.data.frame(res_shrunk)
res_df$ASV <- rownames(res_df)
head(res_df)
############Differential abundance plot
################
library(tidyverse)
colnames(otu_table(ps))
rownames(sample_data(ps))
table(sample_data(ps)$Treatment)
ggplot(plot_df, aes(x = Taxon, y = log2FC, fill = Significant)) +
geom_col(width = 0.8) +
scale_fill_manual(values = c("grey70", "red")) +
facet_wrap(~TaxLevel, scales = "free_x", nrow = 2) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(
x = NULL,
y = "log2 Fold Change (TO22 vs deltaAv2)",
fill = "Significant (padj < 0.05)"
) +
theme_bw(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.background = element_rect(fill = "white"),
strip.text = element_text(face = "bold"),
legend.position = "top"
)
plot_df <- plot_df %>%
group_by(TaxLevel) %>%
mutate(Taxon = factor(Taxon, levels = Taxon[order(log2FC)]))
tax <- as.data.frame(as(tax_table(ps), "matrix")) %>%
rownames_to_column("ASV")
res_df <- as.data.frame(res_TO22_shrunk) %>%
rownames_to_column("ASV")
res_tax <- left_join(res_df, tax, by = "ASV")
genus_df <- res_tax %>%
filter(!is.na(Genus)) %>%
group_by(Genus) %>%
summarise(
log2FC = mean(log2FoldChange, na.rm = TRUE),
padj = min(padj, na.rm = TRUE)
) %>%
mutate(
Significant = padj < 0.05,
TaxLevel = "Genus",
Taxon = Genus
)
phylum_df <- res_tax %>%
filter(!is.na(Phylum)) %>%
group_by(Phylum) %>%
summarise(
log2FC = mean(log2FoldChange, na.rm = TRUE),
padj = min(padj, na.rm = TRUE)
) %>%
mutate(
Significant = padj < 0.05,
TaxLevel = "Phylum",
Taxon = Phylum
)
plot_df <- bind_rows(genus_df, phylum_df)
plot_df <- plot_df %>%
group_by(TaxLevel) %>%
mutate(Taxon = factor(Taxon, levels = Taxon[order(log2FC)]))
ggplot(plot_df, aes(x = Taxon, y = log2FC, fill = Significant)) +
geom_col(width = 0.8) +
scale_fill_manual(values = c("grey70", "red")) +
facet_wrap(~TaxLevel, scales = "free_x", nrow = 2) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(
x = NULL,
y = "log2 Fold Change (TO22 vs deltaAv2)",
fill = "Significant (padj < 0.05)"
) +
theme_bw(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.background = element_rect(fill = "white"),
strip.text = element_text(face = "bold"),
legend.position = "top"
)
ggplot(plot_df, aes(x = Taxon, y = log2FC, fill = Significant)) +
geom_col(width = 0.8) +
scale_fill_manual(values = c("grey70", "red")) +
facet_wrap(~TaxLevel, scales = "free_x", nrow = 2) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(
x = NULL,
y = "log2 Fold Change (TO22 vs deltaAv2)",
fill = "Significant (padj < 0.05)"
) +
theme_bw(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.background = element_rect(fill = "white"),
strip.text = element_text(face = "bold"),
legend.position = "top"
)
p_order <- ggplot(order_plot, aes(x = log2FC, y = Order, color = Phylum)) +
geom_point(size = 5) +
geom_vline(xintercept = 0, linetype = "dashed") +
theme_bw(base_size = 14) +
labs(title = "Order-level log2 Fold Change (TO22 vs deltaAv2)",
x = "log2 Fold Change", y = "") +
theme(
axis.text.y = element_text(face = "italic"),
plot.title = element_text(size = 16, face = "bold")
)
### 7. Print both
p_genus
p_order
# Use your ps object
ps.ra <- transform_sample_counts(ps, function(x) x / sum(x))  # relative abundance
# Agglomerate at phylum level
ps.phylum <- tax_glom(ps.ra, taxrank = "Phylum")
# Melt into long format for ggplot
df.phylum <- psmelt(ps.phylum)
# Order phyla by abundance
df.phylum$Phylum <- factor(df.phylum$Phylum,
levels = names(sort(tapply(df.phylum$Abundance,
df.phylum$Phylum,
mean), decreasing = TRUE)))
# Plot
ggplot(df.phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
facet_wrap(~ Treatment, scales = "free_x") +
theme_bw(base_size = 14) +
labs(y = "Relative Abundance", x = "",
title = "Phylum-level Differential Abundance per Treatment") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# -------------------------
# 1. Agglomerate to Phylum
# -------------------------
ps_phylum <- tax_glom(ps, taxrank = "Phylum")
# -------------------------
# 2. Convert to relative abundance
# -------------------------
ps_phylum_rel <- transform_sample_counts(ps_phylum, function(x) x / sum(x))
# -------------------------
# 3. Summarize by Treatment (average replicates)
# -------------------------
df <- psmelt(ps_phylum_rel)
df_summary <- df %>%
group_by(Treatment, Phylum) %>%
summarise(RelAbund = mean(Abundance), .groups="drop")
# -------------------------
# 4. Bar plot: one bar per Treatment
# -------------------------
ggplot(df_summary, aes(x = Treatment, y = RelAbund, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 14) +
labs(
x = "Treatment",
y = "Relative Abundance",
fill = "Phylum",
title = "Relative Abundance of Major Phyla"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Transform to relative abundance
ps_rel <- transform_sample_counts(ps, function(x) x / sum(x))
# Agglomerate to Phylum level
ps_phylum <- tax_glom(ps_rel, taxrank = "Phylum")
# Melt to long format
df_phylum <- psmelt(ps_phylum)
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
# Transform to relative abundance
ps_rel <- transform_sample_counts(ps.clean, function(x) x / sum(x))
# Agglomerate to Phylum level
ps_phylum <- tax_glom(ps_rel, taxrank = "Phylum")
# Melt to long format
df_phylum <- psmelt(ps_phylum)
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
save.image(".RData")
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
library(ggplot2)
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
library(ggplot2)
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
library(ggplot2)
# Simple clean barplot (same as earlier)
ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
# Simple clean barplot (same as earlier)
relabun <- ggplot(df_phylum, aes(x = Treatment, y = Abundance, fill = Phylum)) +
geom_bar(stat = "identity", position = "stack") +
theme_bw(base_size = 12) +
labs(y = "Relative Abundance", x = "") +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right"
)
relabun
